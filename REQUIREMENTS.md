# Agents智能对话系统 - 需求规格说明书

**版本**: v1.1
**日期**: 2026-01-28
**项目名称**: Agents智能助手（多Agent门户版）

---

## 1. 项目概述

### 1.1 项目背景
Agents智能对话系统是一个基于 Web 的多 Agent 门户应用，通过集成阿里云百炼平台的多个智能体能力，为用户提供专业化的 AI 服务。系统支持多种类型的 Agent（如情感分析、代码助手、数据分析等），用户可根据需求灵活切换不同的 Agent 进行对话。

### 1.2 项目目标
- 提供统一的 Agent 门户入口，支持多 Agent 管理
- 支持多 Agent 配置和灵活切换
- 提供简洁、易用的对话交互界面
- 支持实时流式对话响应
- 展示 AI 思考过程，增强用户信任度
- 支持富文本内容渲染（Markdown、代码、表格等）

### 1.3 目标用户
- 需要Agents支持的用户
- 智能对话应用的使用者
- 开发者和测试人员

---

## 2. 功能需求

### 2.1 核心功能

#### 2.1.1 多 Agent 凭证配置
**功能描述**: 支持配置多个 Agent 的 API 凭证，实现多 Agent 门户管理

**需求细节**:
- 支持配置多个阿里云百炼平台的 AppID 和 API Key
- 多 Agent 凭证格式：`AppID1|API Key1;AppID2|API Key2;AppID3|API Key3`
  - 使用 `|` 分隔 AppID 和 API Key
  - 使用 `;` 分隔不同的 Agent 配置
  - 示例：`agent_001|sk-abc123;agent_002|sk-def456;agent_003|sk-ghi789`
- 每个凭组合需要配置对应的 Agent 信息（名称、类型、描述）
- 凭证存储在浏览器 localStorage 中
- 支持凭证批量导入和单独更新
- 密码输入框保护敏感信息
- 提供格式验证和错误提示

**验收标准**:
- [ ] 首次访问自动弹出配置窗口
- [ ] 支持单 Agent 和多 Agent 两种配置模式
- [ ] 输入格式校验（必须包含正确的分隔符）
- [ ] 配置成功后自动跳转到 Agent 选择页面
- [ ] 刷新页面后凭证自动加载
- [ ] 支持凭证的增删改查操作

#### 2.1.2 对话交互
**功能描述**: 用户与 AI 进行实时对话

**需求细节**:
- 支持多轮对话
- 输入框自动高度调整
- 支持 Enter 键发送（Shift+Enter 换行）
- 发送按钮状态管理（发送中禁用）
- 消息时间顺序显示

**验收标准**:
- [ ] 用户消息显示在右侧
- [ ] AI 消息显示在左侧
- [ ] 消息气泡有明显的视觉区分
- [ ] 新消息自动滚动到底部
- [ ] 发送过程中显示"思考中..."状态

#### 2.1.3 流式响应
**功能描述**: 支持 SSE（Server-Sent Events）流式输出

**需求细节**:
- 通过 `X-DashScope-SSE: enable` 启用流式响应
- 增量输出模式：`incremental_output: true`
- 支持思考过程输出：`has_thoughts: true`
- 实时更新消息内容
- 智能判断增量/全量输出

**验收标准**:
- [ ] AI 响应实时流式显示
- [ ] 思考过程和正文分别处理
- [ ] 流式输出无明显卡顿
- [ ] 错误处理和提示

#### 2.1.4 内容渲染
**功能描述**: 支持多种格式的内容渲染

**需求细节**:
- **Markdown 渲染**:
  - 标题、列表、引用、粗体、斜体
  - 链接自动识别
  - 使用 markdown-it 库

- **代码高亮**:
  - 支持 Python、JavaScript、Bash、JSON 等语言
  - 使用 Prism.js 库
  - Tomorrow Night 主题

- **表格渲染**:
  - JSON 数据自动转换为表格
  - 支持横向滚动
  - 斑马纹样式
  - 鼠标悬停高亮

- **思考过程展示**:
  - 可折叠的 details 元素
  - 默认展开状态
  - 支持收起/展开切换

**验收标准**:
- [ ] Markdown 格式正确渲染
- [ ] 代码块语法高亮正确
- [ ] JSON 数组自动转换为表格
- [ ] 表格在移动端可横向滚动
- [ ] 思考过程折叠功能正常

#### 2.1.5 Agent 选择与管理（新增）
**功能描述**: 提供统一的 Agent 选择门户页面，支持多 Agent 切换和管理

**需求细节**:
- **Agent 选择页面**:
  - 卡片式布局展示所有可用 Agent
  - 每个 Agent 显示：名称、类型、描述、状态
  - 支持 Agent 分类筛选（全部、情感分析、代码助手、数据分析等）
  - 支持搜索功能（按名称或描述搜索）
  - 卡片包含 Agent 的图标/头像
  - 显示 Agent 最近使用时间
  - 标记当前正在使用的 Agent

- **Agent 配置管理（Config 驱动）**:
  - **设计原则**: 通过配置文件管理 Agent，无需修改代码即可增删 Agent
  - **配置格式**: JSON 对象数组，存储在 localStorage
  - **配置内容**:
    ```json
    {
      "agents": [
        {
          "id": "agent_001",
          "name": "情感分析助手",
          "type": "情感分析",
          "description": "专注于情感识别、情绪支持和心理疏导",
          "appId": "app_xxx",
          "apiKey": "sk-xxx",
          "icon": "🤖",
          "enabled": true,
          "order": 1
        },
        {
          "id": "agent_002",
          "name": "代码助手",
          "type": "代码开发",
          "description": "编程辅助、代码审查、技术问题解答",
          "appId": "app_yyy",
          "apiKey": "sk-yyy",
          "icon": "💻",
          "enabled": true,
          "order": 2
        }
      ]
    }
    ```
  - **配置管理功能**:
    - 提供可视化的配置编辑界面
    - 支持添加新 Agent（填写配置项）
    - 支持删除 Agent（从配置中移除）
    - 支持编辑 Agent 配置
    - 支持调整显示顺序（通过 order 字段）
    - 支持启用/禁用 Agent（通过 enabled 字段）
    - 配置实时保存到 localStorage
    - 提供配置导出/导入功能（JSON 格式）

- **Agent 切换**:
  - 点击 Agent 卡片进入对话界面
  - 对话界面顶部显示当前 Agent 名称和类型
  - 提供"切换 Agent"按钮返回 Agent 选择页面
  - 切换 Agent 时保留各自独立的对话历史
  - 支持快速切换最近使用的 Agent

- **Agent 状态管理**:
  - 显示 Agent 在线/离线状态
  - API 连接失败时标记为不可用
  - 提供 Agent 健康检查功能
  - 显示最后使用时间

**验收标准**:
- [ ] 配置凭证后自动进入 Agent 选择页面
- [ ] Agent 卡片布局美观、响应式适配
- [ ] 搜索和筛选功能正常工作
- [ ] Agent 切换流畅，无页面刷新
- [ ] 每个 Agent 对话历史独立保存
- [ ] 配置管理功能完整可用
- [ ] 移动端 Agent 选择体验良好

**UI 设计要点**:
- Agent 卡片采用网格布局（桌面端 3-4 列，平板端 2 列，移动端 1 列）
- 卡片悬停效果：阴影加深、轻微上移
- 当前 Agent 有明显的视觉标识（边框高亮、徽章等）
- 提供"添加 Agent"快捷入口
- 支持拖拽调整 Agent 顺序（高级功能）

### 2.2 辅助功能

#### 2.2.1 错误处理
**需求细节**:
- API 调用失败时显示错误信息
- 网络超时处理
- 凭证错误提示
- 空响应处理

**验收标准**:
- [ ] 错误信息清晰易懂
- [ ] 错误状态下应用不崩溃
- [ ] 提供重试机制

#### 2.2.2 UI/UX 优化
**需求细节**:
- 消息淡入动画
- 平滑滚动
- 美化滚动条
- 按钮悬停效果
- 输入框焦点状态

**验收标准**:
- [ ] 动画流畅自然
- [ ] 视觉反馈及时
- [ ] 无卡顿和闪烁

---

## 3. 非功能需求

### 3.1 性能要求
- 首屏加载时间 < 2 秒
- 消息发送响应时间 < 500ms
- 流式输出延迟 < 100ms
- 支持长时间对话（100+ 轮）不卡顿

### 3.2 兼容性要求
- **浏览器**:
  - Chrome 90+
  - Firefox 88+
  - Safari 14+
  - Edge 90+
- **设备**:
  - 桌面端（1920x1080 及以上）
  - 平板（768px - 1024px）
  - 移动端（320px - 768px）

### 3.3 安全性要求
- API Key 通过 HTTPS 传输
- 凭证存储在客户端（localStorage）
- 不记录敏感对话内容
- 防止 XSS 攻击（内容转义）

### 3.4 可维护性要求
- 代码结构清晰
- 关键功能有注释
- CSS 使用 CSS 变量管理主题
- 易于主题定制

---

## 4. 界面设计

### 4.1 页面布局

#### 4.1.1 Agent 选择页面
```
┌─────────────────────────────────────────────────┐
│  Header: Agents智能助手        [配置管理] [退出]  │
├─────────────────────────────────────────────────┤
│  [搜索框: 搜索 Agent...]                         │
│  [筛选: 全部 | 情感分析 | 代码助手 | 数据分析]   │
├─────────────────────────────────────────────────┤
│  ┌──────────┐  ┌──────────┐  ┌──────────┐      │
│  │ 🤖 情感   │  │ 💻 代码   │  │ 📊 数据   │      │
│  │   分析   │  │   助手   │  │   分析   │      │
│  │ 描述...  │  │ 描述...  │  │ 描述...  │      │
│  └──────────┘  └──────────┘  └──────────┘      │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐      │
│  │ 📝 写作   │  │ 🔍 搜索   │  │ ➕ 添加   │      │
│  │   助手   │  │   助手   │  │  Agent   │      │
│  │ 描述...  │  │ 描述...  │  │          │      │
│  └──────────┘  └──────────┘  └──────────┘      │
└─────────────────────────────────────────────────┘
```

#### 4.1.2 对话界面
```
┌─────────────────────────────────────┐
│  ← 切换 Agent  🤖 情感分析   ⚙️     │
├─────────────────────────────────────┤
│                                     │
│  聊天区域（可滚动）                  │
│  - AI 消息（左侧）                   │
│  - 用户消息（右侧）                  │
│                                     │
├─────────────────────────────────────┤
│  [输入框]              [发送按钮]   │
└─────────────────────────────────────┘
```

#### 4.1.3 配置管理页面
```
┌─────────────────────────────────────────────────┐
│  ← 返回           Agent 配置管理                 │
├─────────────────────────────────────────────────┤
│  多 Agent 凭证配置                              │
│  ┌─────────────────────────────────────────┐   │
│  │ AppID1|API Key1;AppID2|API Key2;...     │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│  Agent 列表                                     │
│  ┌─────────────────────────────────────────┐   │
│  │ Agent 1                  [编辑] [删除]  │   │
│  │ AppID: agent_001                        │   │
│  │ 类型: 情感分析                          │   │
│  │ 状态: ✅ 在线                           │   │
│  └─────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────┐   │
│  │ Agent 2                  [编辑] [删除]  │   │
│  │ AppID: agent_002                        │   │
│  │ 类型: 代码助手                          │   │
│  │ 状态: ✅ 在线                           │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│                  [+ 添加新 Agent]               │
└─────────────────────────────────────────────────┘
```

### 4.2 设计规范
- **主题色**: `#4f46e5` (靛蓝色)
- **背景色**: `#f9fafb` (浅灰)
- **用户消息**: 蓝色背景，白色文字
- **AI 消息**: 浅灰背景，深灰文字
- **圆角**: 0.75rem - 1rem
- **阴影**: 柔和阴影效果

### 4.3 响应式断点
- **移动端**: < 640px
- **平板**: 640px - 1024px
- **桌面**: > 1024px

---

## 5. 技术架构

### 5.1 技术栈
- **前端**: 原生 HTML/CSS/JavaScript
- **Markdown 渲染**: markdown-it 13.0.1
- **代码高亮**: Prism.js 1.29.0
- **API 集成**: Fetch API + SSE

### 5.2 数据流
```
用户选择 Agent → 获取 Agent 凭证 → 对话交互
                      ↓
              API 请求 → SSE 流式响应
                      ↓
              解析响应数据
                      ↓
          提取正文 + 思考过程
                      ↓
          Markdown 渲染 → 页面更新
```

### 5.3 存储方案
- **localStorage**:
  - `bailian_agents_config`: 所有 Agent 凭证配置（加密存储）
    - 格式：`AppID1|API Key1;AppID2|API Key2;...`
  - `bailian_agents_metadata`: Agent 元数据信息
    - 包含：名称、类型、描述、图标、状态、排序等
  - `bailian_current_agent`: 当前选中的 Agent ID
  - `bailian_chat_history_{agentId}`: 每个 Agent 的对话历史
  - `bailian_last_used`: 各 Agent 最后使用时间

### 5.4 API 集成
- **端点**: `https://dashscope.aliyuncs.com/api/v1/apps/{appId}/completion`
- **认证**: Bearer Token
- **请求头**:
  - `Authorization: Bearer {API Key}`
  - `Content-Type: application/json`
  - `X-DashScope-SSE: enable`

---

## 6. 当前实现状态

### 6.1 已实现功能 ✅
- [x] 单 Agent 凭证配置和存储
- [x] 基础对话界面
- [x] SSE 流式响应
- [x] Markdown 渲染
- [x] 代码语法高亮
- [x] JSON 转 表格
- [x] 思考过程展示
- [x] 响应式设计
- [x] 错误处理

### 6.2 待开发功能 🚀（新增 - v1.1）
- [ ] **多 Agent 凭证配置**
  - [ ] 支持多 Agent 凭证批量导入
  - [ ] 凭证格式解析和验证
  - [ ] 凭证加密存储

- [ ] **Agent 选择页面**
  - [ ] Agent 卡片式展示
  - [ ] 搜索和筛选功能
  - [ ] Agent 分类管理
  - [ ] 响应式布局适配

- [ ] **Agent 配置管理**
  - [ ] Agent 元数据配置（名称、类型、描述）
  - [ ] Agent 启用/禁用
  - [ ] Agent 排序
  - [ ] Agent 图标上传

- [ ] **Agent 切换功能**
  - [ ] Agent 间无缝切换
  - [ ] 独立对话历史管理
  - [ ] 当前 Agent 状态显示
  - [ ] 快速切换入口

- [ ] **对话历史增强**
  - [ ] 按 Agent 隔离存储历史
  - [ ] 历史记录查看和恢复
  - [ ] 清空指定 Agent 历史

### 6.3 待优化功能 🔄
- [ ] 多语言支持（i18n）
- [ ] 深色模式切换
- [ ] 导出对话记录
- [ ] 语音输入支持
- [ ] 快捷指令模板
- [ ] 对话分支管理
- [ ] 使用统计和分析

### 6.4 潜在增强功能 💡
- [ ] Agent 协作模式（多 Agent 共同完成复杂任务）
- [ ] Agent 性能监控和分析
- [ ] 自定义主题配置
- [ ] 插件系统
- [ ] API 代理服务（解决 CORS）
- [ ] 对话分享功能
- [ ] 离线模式支持

---

## 7. 未来迭代方向

### 7.1 短期目标（1-2 周）- v1.1 核心功能
1. **多 Agent 管理系统** ⭐ **优先级最高**
   - 多 Agent 凭证配置和解析
   - Agent 选择门户页面
   - Agent 配置管理界面
   - Agent 切换功能
   - 独立对话历史管理

2. **Agent 体验优化**
   - Agent 卡片视觉设计
   - 搜索和筛选交互优化
   - Agent 状态监控
   - 快速切换入口

3. **基础功能完善**
   - 保存对话历史到 localStorage
   - 支持历史记录查看和恢复
   - 提供清空历史功能

### 7.2 中期目标（1-2 月）- v1.2 增强功能
1. **深色模式和主题**
   - 实现主题切换功能
   - 自动检测系统偏好
   - 主题持久化

2. **快捷指令**
   - 预设常用提示词
   - 一键插入模板
   - 自定义模板管理

3. **多模态支持**
   - 图片输入和分析
   - 文件上传和解析
   - 语音输入/输出

### 7.3 长期目标（3-6 月）- v2.0 生态建设
1. **高级功能**
   - 对话导出（Markdown/PDF）
   - 对话搜索和标签
   - Agent 协作模式

2. **性能优化**
   - 虚拟滚动（长对话）
   - 懒加载和代码分割
   - 缓存策略优化

3. **AI 能力增强**
   - 多模型集成
   - 插件生态
   - 自定义工作流

4. **多端同步**
   - 云端账号系统
   - 跨设备同步
   - 协作功能

---

## 8. 附录

### 8.1 相关文档
- [阿里云百炼平台文档](https://help.aliyun.com/zh/dashscope/)
- [markdown-it 文档](https://github.com/markdown-it/markdown-it)
- [Prism.js 文档](https://prismjs.com/)

### 8.2 版本历史
| 版本 | 日期 | 说明 |
|------|------|------|
| v1.0 | 2026-01-28 | 初始版本（单 Agent） |
| v1.1 | 2026-01-28 | 新增多 Agent 门户功能 |

### 8.3 变更记录
| 日期 | 版本 | 变更内容 | 变更人 |
|------|------|----------|--------|
| 2026-01-28 | v1.0 | 创建需求规格书 | - |
| 2026-01-28 | v1.1 | 新增多 Agent 管理需求：<br>1. 支持多 Agent 凭证配置（格式：AppID1|Key1;AppID2|Key2）<br>2. 新增 Agent 选择门户页面<br>3. 新增 Agent 配置管理功能<br>4. 支持 Agent 切换和独立对话历史<br>5. 更新界面设计（三页面布局）<br>6. 更新技术架构和存储方案 | - |

---

## 9. 联系方式
如有疑问或建议，请联系项目维护者。
